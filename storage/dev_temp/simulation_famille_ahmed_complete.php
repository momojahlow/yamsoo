<?php

/**
 * SIMULATION COMPL√àTE DE LA FAMILLE AHMED
 * 
 * Sc√©nario :
 * 1. Ahmed (papa) ajoute Fatima comme √©pouse
 * 2. Ahmed ajoute Amina comme fille
 * 3. Ahmed ajoute Mohamed comme fils
 * 4. Ahmed ajoute Youssef comme fils
 * 
 * Apr√®s chaque acceptation, v√©rifier les suggestions pour tous les membres
 */

// Charger Laravel
require_once __DIR__ . '/vendor/autoload.php';
$app = require_once __DIR__ . '/bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();

use App\Models\User;
use App\Models\FamilyRelationship;
use App\Models\RelationshipType;
use App\Models\Suggestion;
use App\Services\SuggestionService;
use App\Services\FamilyRelationService;
use Illuminate\Support\Facades\DB;

class FamilySimulation
{
    private $suggestionService;
    private $familyRelationService;
    private $users = [];
    private $relationshipTypes = [];
    private $testResults = [];

    public function __construct()
    {
        $this->suggestionService = app(SuggestionService::class);
        $this->familyRelationService = app(FamilyRelationService::class);
        $this->loadRelationshipTypes();
        $this->loadUsers();
    }

    private function loadRelationshipTypes()
    {
        $this->relationshipTypes = RelationshipType::all()->keyBy('name');
        echo "üìã Types de relations charg√©s : " . $this->relationshipTypes->count() . "\n";
    }

    private function loadUsers()
    {
        $this->users = [
            'ahmed' => User::where('name', 'like', '%Ahmed%')->first(),
            'fatima' => User::where('name', 'like', '%Fatima%')->first(),
            'mohamed' => User::where('name', 'like', '%Mohammed%')->first(),
            'amina' => User::where('name', 'like', '%Amina%')->first(),
            'youssef' => User::where('name', 'like', '%Youssef%')->first(),
        ];

        echo "üë• Utilisateurs charg√©s :\n";
        foreach ($this->users as $key => $user) {
            if ($user) {
                echo "   ‚úÖ {$key}: {$user->name} (ID: {$user->id})\n";
            } else {
                echo "   ‚ùå {$key}: NON TROUV√â\n";
                throw new Exception("Utilisateur {$key} non trouv√©");
            }
        }
        echo "\n";
    }

    public function runCompleteSimulation()
    {
        echo "üé¨ SIMULATION COMPL√àTE DE LA FAMILLE AHMED\n";
        echo str_repeat("=", 80) . "\n\n";

        // √âtape 0: Nettoyer la base
        $this->cleanDatabase();

        // √âtape 1: Ahmed ajoute Fatima comme √©pouse
        $this->step1_AhmedAjouteFatima();

        // √âtape 2: Ahmed ajoute Amina comme fille
        $this->step2_AhmedAjouteAmina();

        // √âtape 3: Ahmed ajoute Mohamed comme fils
        $this->step3_AhmedAjouteMohamed();

        // √âtape 4: Ahmed ajoute Youssef comme fils
        $this->step4_AhmedAjouteYoussef();

        // √âtape 5: Tests finaux complets
        $this->step5_TestsFinaux();

        // Rapport final
        $this->generateFinalReport();
    }

    private function cleanDatabase()
    {
        echo "üßπ √âTAPE 0: NETTOYAGE DE LA BASE\n";
        echo str_repeat("-", 50) . "\n";

        // Supprimer toutes les suggestions
        $suggestionsDeleted = Suggestion::count();
        Suggestion::truncate();
        echo "   üóëÔ∏è {$suggestionsDeleted} suggestions supprim√©es\n";

        // Supprimer toutes les relations familiales
        $relationsDeleted = FamilyRelationship::count();
        FamilyRelationship::truncate();
        echo "   üóëÔ∏è {$relationsDeleted} relations familiales supprim√©es\n";

        echo "   ‚úÖ Base de donn√©es nettoy√©e\n\n";
    }

    private function step1_AhmedAjouteFatima()
    {
        echo "üíë √âTAPE 1: AHMED AJOUTE FATIMA COMME √âPOUSE\n";
        echo str_repeat("-", 50) . "\n";

        $this->createRelation(
            $this->users['ahmed'],
            $this->users['fatima'],
            'husband',
            "Ahmed ajoute Fatima comme √©pouse"
        );

        // Tester les suggestions apr√®s cette relation
        $this->testSuggestionsAfterStep("√âtape 1", [
            'ahmed' => [
                // Ahmed ne devrait pas avoir de nouvelles suggestions familiales
                // car il n'y a que lui et Fatima pour l'instant
            ],
            'fatima' => [
                // Fatima ne devrait pas avoir de nouvelles suggestions familiales
                // car il n'y a que elle et Ahmed pour l'instant
            ]
        ]);

        echo "\n";
    }

    private function step2_AhmedAjouteAmina()
    {
        echo "üëß √âTAPE 2: AHMED AJOUTE AMINA COMME FILLE\n";
        echo str_repeat("-", 50) . "\n";

        $this->createRelation(
            $this->users['ahmed'],
            $this->users['amina'],
            'father',
            "Ahmed ajoute Amina comme fille"
        );

        // Tester les suggestions apr√®s cette relation
        $this->testSuggestionsAfterStep("√âtape 2", [
            'ahmed' => [
                // Ahmed ne devrait pas avoir de nouvelles suggestions
            ],
            'fatima' => [
                // Fatima devrait voir Amina comme fille (via mariage avec Ahmed)
                $this->users['amina']->id => 'daughter'
            ],
            'amina' => [
                // Amina devrait voir Fatima comme m√®re (√©pouse du p√®re)
                $this->users['fatima']->id => 'mother'
            ]
        ]);

        echo "\n";
    }

    private function step3_AhmedAjouteMohamed()
    {
        echo "üë¶ √âTAPE 3: AHMED AJOUTE MOHAMED COMME FILS\n";
        echo str_repeat("-", 50) . "\n";

        $this->createRelation(
            $this->users['ahmed'],
            $this->users['mohamed'],
            'father',
            "Ahmed ajoute Mohamed comme fils"
        );

        // Tester les suggestions apr√®s cette relation
        $this->testSuggestionsAfterStep("√âtape 3", [
            'ahmed' => [
                // Ahmed ne devrait pas avoir de nouvelles suggestions
            ],
            'fatima' => [
                // Fatima devrait voir Mohamed comme fils
                $this->users['mohamed']->id => 'son'
            ],
            'amina' => [
                // Amina devrait voir Mohamed comme fr√®re
                $this->users['mohamed']->id => 'brother'
            ],
            'mohamed' => [
                // Mohamed devrait voir Fatima comme m√®re et Amina comme s≈ìur
                $this->users['fatima']->id => 'mother',
                $this->users['amina']->id => 'sister'
            ]
        ]);

        echo "\n";
    }

    private function step4_AhmedAjouteYoussef()
    {
        echo "üë¶ √âTAPE 4: AHMED AJOUTE YOUSSEF COMME FILS\n";
        echo str_repeat("-", 50) . "\n";

        $this->createRelation(
            $this->users['ahmed'],
            $this->users['youssef'],
            'father',
            "Ahmed ajoute Youssef comme fils"
        );

        // Tester les suggestions apr√®s cette relation
        $this->testSuggestionsAfterStep("√âtape 4", [
            'ahmed' => [
                // Ahmed ne devrait pas avoir de nouvelles suggestions
            ],
            'fatima' => [
                // Fatima devrait voir Youssef comme fils
                $this->users['youssef']->id => 'son'
            ],
            'amina' => [
                // Amina devrait voir Youssef comme fr√®re
                $this->users['youssef']->id => 'brother'
            ],
            'mohamed' => [
                // Mohamed devrait voir Youssef comme fr√®re
                $this->users['youssef']->id => 'brother'
            ],
            'youssef' => [
                // Youssef devrait voir Fatima comme m√®re, Amina comme s≈ìur, Mohamed comme fr√®re
                $this->users['fatima']->id => 'mother',
                $this->users['amina']->id => 'sister',
                $this->users['mohamed']->id => 'brother'
            ]
        ]);

        echo "\n";
    }

    private function step5_TestsFinaux()
    {
        echo "üéØ √âTAPE 5: TESTS FINAUX COMPLETS\n";
        echo str_repeat("-", 50) . "\n";

        // Tester toutes les suggestions pour tous les membres
        $expectedSuggestions = [
            'ahmed' => [
                // Ahmed a d√©j√† toutes ses relations directes, pas de suggestions attendues
            ],
            'fatima' => [
                // Fatima devrait voir tous les enfants d'Ahmed comme ses enfants
                $this->users['amina']->id => 'daughter',
                $this->users['mohamed']->id => 'son',
                $this->users['youssef']->id => 'son'
            ],
            'amina' => [
                // Amina devrait voir Fatima comme m√®re et ses fr√®res
                $this->users['fatima']->id => 'mother',
                $this->users['mohamed']->id => 'brother',
                $this->users['youssef']->id => 'brother'
            ],
            'mohamed' => [
                // Mohamed devrait voir Fatima comme m√®re et ses fr√®res/s≈ìurs
                $this->users['fatima']->id => 'mother',
                $this->users['amina']->id => 'sister',
                $this->users['youssef']->id => 'brother'
            ],
            'youssef' => [
                // Youssef devrait voir Fatima comme m√®re et ses fr√®res/s≈ìurs
                $this->users['fatima']->id => 'mother',
                $this->users['amina']->id => 'sister',
                $this->users['mohamed']->id => 'brother'
            ]
        ];

        $this->testSuggestionsAfterStep("Tests finaux", $expectedSuggestions);
    }

    private function createRelation($user1, $user2, $relationType, $description)
    {
        echo "   üîó {$description}\n";
        
        $relationshipType = $this->relationshipTypes[$relationType];
        if (!$relationshipType) {
            throw new Exception("Type de relation '{$relationType}' non trouv√©");
        }

        // Cr√©er la relation directement comme accept√©e
        $relation = FamilyRelationship::create([
            'user_id' => $user1->id,
            'related_user_id' => $user2->id,
            'relationship_type_id' => $relationshipType->id,
            'status' => 'accepted',
            'created_automatically' => false,
            'created_at' => now(),
            'updated_at' => now()
        ]);

        // Cr√©er la relation inverse
        $inverseType = $this->getInverseRelationType($relationType, $user2);
        if ($inverseType) {
            FamilyRelationship::create([
                'user_id' => $user2->id,
                'related_user_id' => $user1->id,
                'relationship_type_id' => $inverseType->id,
                'status' => 'accepted',
                'created_automatically' => true,
                'created_at' => now(),
                'updated_at' => now()
            ]);
        }

        echo "   ‚úÖ Relation cr√©√©e : {$user1->name} ‚Üî {$user2->name} ({$relationType})\n";
    }

    private function getInverseRelationType($relationType, $targetUser)
    {
        $gender = $targetUser->profile?->gender ?? $this->guessGenderFromName($targetUser);
        
        $inverseMap = [
            'husband' => 'wife',
            'wife' => 'husband',
            'father' => $gender === 'female' ? 'daughter' : 'son',
            'mother' => $gender === 'female' ? 'daughter' : 'son',
            'son' => 'father', // On ne peut pas deviner le genre du parent
            'daughter' => 'mother', // On ne peut pas deviner le genre du parent
            'brother' => $gender === 'female' ? 'sister' : 'brother',
            'sister' => $gender === 'female' ? 'sister' : 'brother'
        ];

        $inverseName = $inverseMap[$relationType] ?? null;
        return $inverseName ? $this->relationshipTypes[$inverseName] : null;
    }

    private function guessGenderFromName($user)
    {
        $name = strtolower($user->name);
        $maleNames = ['ahmed', 'mohamed', 'mohammed', 'youssef', 'omar', 'karim'];
        $femaleNames = ['fatima', 'amina', 'leila', 'nadia', 'zineb'];
        
        foreach ($maleNames as $maleName) {
            if (strpos($name, $maleName) !== false) {
                return 'male';
            }
        }
        
        foreach ($femaleNames as $femaleName) {
            if (strpos($name, $femaleName) !== false) {
                return 'female';
            }
        }
        
        return 'male'; // Par d√©faut
    }

    private function testSuggestionsAfterStep($stepName, $expectedSuggestions)
    {
        echo "   üß™ Test des suggestions apr√®s {$stepName}:\n";
        
        foreach ($expectedSuggestions as $userKey => $expectations) {
            $user = $this->users[$userKey];
            
            // Supprimer les anciennes suggestions
            Suggestion::where('user_id', $user->id)->delete();
            
            // G√©n√©rer de nouvelles suggestions
            $suggestions = $this->suggestionService->generateSuggestions($user);
            
            echo "      üë§ {$user->name} ({$suggestions->count()} suggestions):\n";
            
            if (empty($expectations)) {
                if ($suggestions->count() === 0) {
                    echo "         ‚úÖ Aucune suggestion attendue, aucune g√©n√©r√©e\n";
                } else {
                    echo "         ‚ö†Ô∏è Aucune suggestion attendue, mais {$suggestions->count()} g√©n√©r√©e(s)\n";
                    foreach ($suggestions as $suggestion) {
                        echo "            - {$suggestion->suggestedUser->name} : {$suggestion->suggested_relation_code}\n";
                    }
                }
                continue;
            }
            
            foreach ($expectations as $expectedUserId => $expectedRelation) {
                $suggestion = $suggestions->first(function ($s) use ($expectedUserId) {
                    return $s->suggested_user_id === $expectedUserId;
                });
                
                $expectedUser = collect($this->users)->first(function ($u) use ($expectedUserId) {
                    return $u->id === $expectedUserId;
                });
                
                if (!$suggestion) {
                    echo "         ‚ùå {$expectedUser->name} : AUCUNE SUGGESTION (attendu: {$expectedRelation})\n";
                    $this->testResults[] = [
                        'step' => $stepName,
                        'user' => $user->name,
                        'expected_user' => $expectedUser->name,
                        'expected_relation' => $expectedRelation,
                        'actual_relation' => 'none',
                        'success' => false
                    ];
                } elseif ($suggestion->suggested_relation_code === $expectedRelation) {
                    echo "         ‚úÖ {$expectedUser->name} : {$suggestion->suggested_relation_code} (correct)\n";
                    $this->testResults[] = [
                        'step' => $stepName,
                        'user' => $user->name,
                        'expected_user' => $expectedUser->name,
                        'expected_relation' => $expectedRelation,
                        'actual_relation' => $suggestion->suggested_relation_code,
                        'success' => true
                    ];
                } else {
                    echo "         ‚ùå {$expectedUser->name} : {$suggestion->suggested_relation_code} (attendu: {$expectedRelation})\n";
                    $this->testResults[] = [
                        'step' => $stepName,
                        'user' => $user->name,
                        'expected_user' => $expectedUser->name,
                        'expected_relation' => $expectedRelation,
                        'actual_relation' => $suggestion->suggested_relation_code,
                        'success' => false
                    ];
                }
            }
        }
    }

    private function generateFinalReport()
    {
        echo "üìä RAPPORT FINAL DE LA SIMULATION\n";
        echo str_repeat("=", 80) . "\n\n";

        $totalTests = count($this->testResults);
        $successfulTests = count(array_filter($this->testResults, function ($r) { return $r['success']; }));
        $failedTests = $totalTests - $successfulTests;

        echo "üìà Statistiques globales :\n";
        echo "   - Tests ex√©cut√©s : {$totalTests}\n";
        echo "   - Tests r√©ussis : {$successfulTests}\n";
        echo "   - Tests √©chou√©s : {$failedTests}\n";
        echo "   - Taux de r√©ussite : " . round(($successfulTests / max($totalTests, 1)) * 100, 1) . "%\n\n";

        if ($failedTests > 0) {
            echo "‚ùå Tests √©chou√©s :\n";
            foreach ($this->testResults as $result) {
                if (!$result['success']) {
                    echo "   - {$result['step']} | {$result['user']} ‚Üí {$result['expected_user']} : ";
                    echo "Attendu {$result['expected_relation']}, Obtenu {$result['actual_relation']}\n";
                }
            }
            echo "\n";
        }

        // Afficher l'√©tat final de la famille
        echo "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Structure familiale finale :\n";
        $finalRelations = FamilyRelationship::with(['user', 'relatedUser', 'relationshipType'])->get();
        foreach ($finalRelations as $relation) {
            echo "   - {$relation->user->name} ‚Üí {$relation->relatedUser->name} : {$relation->relationshipType->display_name_fr}\n";
        }

        echo "\n";
        if ($failedTests === 0) {
            echo "üéâ SUCC√àS COMPLET ! Toutes les suggestions familiales fonctionnent correctement.\n";
        } else {
            echo "‚ö†Ô∏è Des probl√®mes subsistent dans le syst√®me de suggestions.\n";
        }
    }
}

// Ex√©cuter la simulation
try {
    $simulation = new FamilySimulation();
    $simulation->runCompleteSimulation();
} catch (Exception $e) {
    echo "‚ùå Erreur lors de la simulation : " . $e->getMessage() . "\n";
    echo "üìã Trace : " . $e->getTraceAsString() . "\n";
    exit(1);
}
