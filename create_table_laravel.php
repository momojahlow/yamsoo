<?php

/**
 * Script Laravel pour cr√©er la table relationship_types
 * Ex√©cuter avec: php create_table_laravel.php
 */

// Charger Laravel
require_once __DIR__ . '/vendor/autoload.php';

$app = require_once __DIR__ . '/bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();

use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;
use Illuminate\Database\Schema\Blueprint;

echo "üîß Cr√©ation de la table relationship_types avec Laravel...\n";

try {
    // 1. Supprimer la table si elle existe
    echo "üóëÔ∏è Suppression de l'ancienne table...\n";
    Schema::dropIfExists('relationship_types');
    
    // 2. Cr√©er la nouvelle table
    echo "üèóÔ∏è Cr√©ation de la nouvelle table...\n";
    Schema::create('relationship_types', function (Blueprint $table) {
        $table->id();
        $table->string('name')->unique();
        $table->string('display_name_fr');
        $table->string('display_name_ar');
        $table->string('display_name_en');
        $table->text('description')->nullable();
        $table->string('reverse_relationship')->nullable();
        $table->string('category')->default('direct');
        $table->integer('generation_level')->default(0);
        $table->integer('sort_order')->default(1);
        $table->timestamps();
        
        // Index
        $table->index('category');
        $table->index('generation_level');
        $table->index('sort_order');
    });
    
    echo "‚úÖ Table cr√©√©e avec succ√®s!\n";
    
    // 3. Ins√©rer les donn√©es
    echo "üå± Insertion des types de relations...\n";
    
    $relationshipTypes = [
        ['name' => 'parent', 'display_name_fr' => 'Parent', 'display_name_ar' => 'ŸàÿßŸÑÿØ/ŸàÿßŸÑÿØÿ©', 'display_name_en' => 'Parent', 'description' => 'Relation parent-enfant directe', 'reverse_relationship' => 'child', 'category' => 'direct', 'generation_level' => -1, 'sort_order' => 1],
        ['name' => 'father', 'display_name_fr' => 'P√®re', 'display_name_ar' => 'ÿ£ÿ®', 'display_name_en' => 'Father', 'description' => 'P√®re biologique ou adoptif', 'reverse_relationship' => 'child', 'category' => 'direct', 'generation_level' => -1, 'sort_order' => 2],
        ['name' => 'mother', 'display_name_fr' => 'M√®re', 'display_name_ar' => 'ÿ£ŸÖ', 'display_name_en' => 'Mother', 'description' => 'M√®re biologique ou adoptive', 'reverse_relationship' => 'child', 'category' => 'direct', 'generation_level' => -1, 'sort_order' => 3],
        ['name' => 'child', 'display_name_fr' => 'Enfant', 'display_name_ar' => 'ÿ∑ŸÅŸÑ/ÿ∑ŸÅŸÑÿ©', 'display_name_en' => 'Child', 'description' => 'Enfant biologique ou adoptif', 'reverse_relationship' => 'parent', 'category' => 'direct', 'generation_level' => 1, 'sort_order' => 4],
        ['name' => 'son', 'display_name_fr' => 'Fils', 'display_name_ar' => 'ÿßÿ®ŸÜ', 'display_name_en' => 'Son', 'description' => 'Fils biologique ou adoptif', 'reverse_relationship' => 'parent', 'category' => 'direct', 'generation_level' => 1, 'sort_order' => 5],
        ['name' => 'daughter', 'display_name_fr' => 'Fille', 'display_name_ar' => 'ÿßÿ®ŸÜÿ©', 'display_name_en' => 'Daughter', 'description' => 'Fille biologique ou adoptive', 'reverse_relationship' => 'parent', 'category' => 'direct', 'generation_level' => 1, 'sort_order' => 6],
        ['name' => 'spouse', 'display_name_fr' => '√âpoux/√âpouse', 'display_name_ar' => 'ÿ≤Ÿàÿ¨/ÿ≤Ÿàÿ¨ÿ©', 'display_name_en' => 'Spouse', 'description' => 'Conjoint mari√©', 'reverse_relationship' => 'spouse', 'category' => 'marriage', 'generation_level' => 0, 'sort_order' => 7],
        ['name' => 'husband', 'display_name_fr' => 'Mari', 'display_name_ar' => 'ÿ≤Ÿàÿ¨', 'display_name_en' => 'Husband', 'description' => '√âpoux masculin', 'reverse_relationship' => 'wife', 'category' => 'marriage', 'generation_level' => 0, 'sort_order' => 8],
        ['name' => 'wife', 'display_name_fr' => '√âpouse', 'display_name_ar' => 'ÿ≤Ÿàÿ¨ÿ©', 'display_name_en' => 'Wife', 'description' => '√âpouse f√©minine', 'reverse_relationship' => 'husband', 'category' => 'marriage', 'generation_level' => 0, 'sort_order' => 9],
        ['name' => 'sibling', 'display_name_fr' => 'Fr√®re/S≈ìur', 'display_name_ar' => 'ÿ£ÿÆ/ÿ£ÿÆÿ™', 'display_name_en' => 'Sibling', 'description' => 'Fr√®re ou s≈ìur', 'reverse_relationship' => 'sibling', 'category' => 'direct', 'generation_level' => 0, 'sort_order' => 10],
        ['name' => 'brother', 'display_name_fr' => 'Fr√®re', 'display_name_ar' => 'ÿ£ÿÆ', 'display_name_en' => 'Brother', 'description' => 'Fr√®re biologique ou adoptif', 'reverse_relationship' => 'sibling', 'category' => 'direct', 'generation_level' => 0, 'sort_order' => 11],
        ['name' => 'sister', 'display_name_fr' => 'S≈ìur', 'display_name_ar' => 'ÿ£ÿÆÿ™', 'display_name_en' => 'Sister', 'description' => 'S≈ìur biologique ou adoptive', 'reverse_relationship' => 'sibling', 'category' => 'direct', 'generation_level' => 0, 'sort_order' => 12],
        ['name' => 'grandparent', 'display_name_fr' => 'Grand-parent', 'display_name_ar' => 'ÿ¨ÿØ/ÿ¨ÿØÿ©', 'display_name_en' => 'Grandparent', 'description' => 'Grand-p√®re ou grand-m√®re', 'reverse_relationship' => 'grandchild', 'category' => 'extended', 'generation_level' => -2, 'sort_order' => 13],
        ['name' => 'grandfather', 'display_name_fr' => 'Grand-p√®re', 'display_name_ar' => 'ÿ¨ÿØ', 'display_name_en' => 'Grandfather', 'description' => 'P√®re du p√®re ou de la m√®re', 'reverse_relationship' => 'grandchild', 'category' => 'extended', 'generation_level' => -2, 'sort_order' => 14],
        ['name' => 'grandmother', 'display_name_fr' => 'Grand-m√®re', 'display_name_ar' => 'ÿ¨ÿØÿ©', 'display_name_en' => 'Grandmother', 'description' => 'M√®re du p√®re ou de la m√®re', 'reverse_relationship' => 'grandchild', 'category' => 'extended', 'generation_level' => -2, 'sort_order' => 15],
        ['name' => 'grandchild', 'display_name_fr' => 'Petit-enfant', 'display_name_ar' => 'ÿ≠ŸÅŸäÿØ/ÿ≠ŸÅŸäÿØÿ©', 'display_name_en' => 'Grandchild', 'description' => 'Enfant de son enfant', 'reverse_relationship' => 'grandparent', 'category' => 'extended', 'generation_level' => 2, 'sort_order' => 16],
        ['name' => 'grandson', 'display_name_fr' => 'Petit-fils', 'display_name_ar' => 'ÿ≠ŸÅŸäÿØ', 'display_name_en' => 'Grandson', 'description' => 'Fils de son enfant', 'reverse_relationship' => 'grandparent', 'category' => 'extended', 'generation_level' => 2, 'sort_order' => 17],
        ['name' => 'granddaughter', 'display_name_fr' => 'Petite-fille', 'display_name_ar' => 'ÿ≠ŸÅŸäÿØÿ©', 'display_name_en' => 'Granddaughter', 'description' => 'Fille de son enfant', 'reverse_relationship' => 'grandparent', 'category' => 'extended', 'generation_level' => 2, 'sort_order' => 18],
        ['name' => 'uncle', 'display_name_fr' => 'Oncle', 'display_name_ar' => 'ÿπŸÖ/ÿÆÿßŸÑ', 'display_name_en' => 'Uncle', 'description' => 'Fr√®re du p√®re ou de la m√®re', 'reverse_relationship' => 'nephew_niece', 'category' => 'extended', 'generation_level' => -1, 'sort_order' => 19],
        ['name' => 'aunt', 'display_name_fr' => 'Tante', 'display_name_ar' => 'ÿπŸÖÿ©/ÿÆÿßŸÑÿ©', 'display_name_en' => 'Aunt', 'description' => 'S≈ìur du p√®re ou de la m√®re', 'reverse_relationship' => 'nephew_niece', 'category' => 'extended', 'generation_level' => -1, 'sort_order' => 20],
        ['name' => 'nephew', 'display_name_fr' => 'Neveu', 'display_name_ar' => 'ÿßÿ®ŸÜ ÿ£ÿÆ/ÿ£ÿÆÿ™', 'display_name_en' => 'Nephew', 'description' => 'Fils du fr√®re ou de la s≈ìur', 'reverse_relationship' => 'uncle_aunt', 'category' => 'extended', 'generation_level' => 1, 'sort_order' => 21],
        ['name' => 'niece', 'display_name_fr' => 'Ni√®ce', 'display_name_ar' => 'ÿßÿ®ŸÜÿ© ÿ£ÿÆ/ÿ£ÿÆÿ™', 'display_name_en' => 'Niece', 'description' => 'Fille du fr√®re ou de la s≈ìur', 'reverse_relationship' => 'uncle_aunt', 'category' => 'extended', 'generation_level' => 1, 'sort_order' => 22],
        ['name' => 'father_in_law', 'display_name_fr' => 'Beau-p√®re', 'display_name_ar' => 'ÿ≠ŸÖŸà', 'display_name_en' => 'Father-in-law', 'description' => 'P√®re du conjoint', 'reverse_relationship' => 'son_daughter_in_law', 'category' => 'marriage', 'generation_level' => -1, 'sort_order' => 23],
        ['name' => 'mother_in_law', 'display_name_fr' => 'Belle-m√®re', 'display_name_ar' => 'ÿ≠ŸÖÿßÿ©', 'display_name_en' => 'Mother-in-law', 'description' => 'M√®re du conjoint', 'reverse_relationship' => 'son_daughter_in_law', 'category' => 'marriage', 'generation_level' => -1, 'sort_order' => 24],
        ['name' => 'son_in_law', 'display_name_fr' => 'Gendre', 'display_name_ar' => 'ÿµŸáÿ±', 'display_name_en' => 'Son-in-law', 'description' => 'Mari de la fille', 'reverse_relationship' => 'father_mother_in_law', 'category' => 'marriage', 'generation_level' => 1, 'sort_order' => 25],
        ['name' => 'daughter_in_law', 'display_name_fr' => 'Belle-fille', 'display_name_ar' => 'ŸÉŸÜÿ©', 'display_name_en' => 'Daughter-in-law', 'description' => '√âpouse du fils', 'reverse_relationship' => 'father_mother_in_law', 'category' => 'marriage', 'generation_level' => 1, 'sort_order' => 26],
        ['name' => 'cousin', 'display_name_fr' => 'Cousin/Cousine', 'display_name_ar' => 'ÿßÿ®ŸÜ/ÿßÿ®ŸÜÿ© ÿπŸÖ/ÿÆÿßŸÑ', 'display_name_en' => 'Cousin', 'description' => 'Enfant de l\'oncle ou de la tante', 'reverse_relationship' => 'cousin', 'category' => 'extended', 'generation_level' => 0, 'sort_order' => 27],
        ['name' => 'adoptive_parent', 'display_name_fr' => 'Parent adoptif', 'display_name_ar' => 'ŸàÿßŸÑÿØ/ŸàÿßŸÑÿØÿ© ÿ®ÿßŸÑÿ™ÿ®ŸÜŸä', 'display_name_en' => 'Adoptive parent', 'description' => 'Parent par adoption l√©gale', 'reverse_relationship' => 'adopted_child', 'category' => 'adoption', 'generation_level' => -1, 'sort_order' => 28],
        ['name' => 'adopted_child', 'display_name_fr' => 'Enfant adopt√©', 'display_name_ar' => 'ÿ∑ŸÅŸÑ/ÿ∑ŸÅŸÑÿ© ÿ®ÿßŸÑÿ™ÿ®ŸÜŸä', 'display_name_en' => 'Adopted child', 'description' => 'Enfant par adoption l√©gale', 'reverse_relationship' => 'adoptive_parent', 'category' => 'adoption', 'generation_level' => 1, 'sort_order' => 29],
        ['name' => 'family_member', 'display_name_fr' => 'Membre de la famille', 'display_name_ar' => 'ŸÅÿ±ÿØ ŸÖŸÜ ÿßŸÑÿπÿßÿ¶ŸÑÿ©', 'display_name_en' => 'Family member', 'description' => 'Membre de la famille (relation non sp√©cifi√©e)', 'reverse_relationship' => 'family_member', 'category' => 'extended', 'generation_level' => 0, 'sort_order' => 30],
    ];
    
    foreach ($relationshipTypes as $type) {
        $type['created_at'] = now();
        $type['updated_at'] = now();
        DB::table('relationship_types')->insert($type);
    }
    
    $count = count($relationshipTypes);
    echo "‚úÖ {$count} types de relations ins√©r√©s!\n";
    
    // 4. V√©rifier le r√©sultat
    echo "\nüîç V√©rification finale...\n";
    $totalCount = DB::table('relationship_types')->count();
    echo "üìä Nombre total: {$totalCount}\n";
    
    // Afficher quelques exemples
    $examples = DB::table('relationship_types')
        ->select('name', 'display_name_fr', 'category')
        ->orderBy('sort_order')
        ->limit(5)
        ->get();
    
    echo "üìã Exemples:\n";
    foreach ($examples as $example) {
        echo "   - {$example->name} ({$example->display_name_fr}, {$example->category})\n";
    }
    
    echo "\nüéâ Succ√®s total!\n";
    echo "‚úÖ Table relationship_types cr√©√©e avec la nouvelle structure\n";
    echo "‚úÖ 30 types de relations ins√©r√©s\n";
    echo "‚úÖ Plus de probl√®me de contrainte NOT NULL\n";
    echo "‚úÖ Structure utilise 'name' au lieu de 'code'\n";
    echo "\nüéØ Vous pouvez maintenant ex√©cuter vos seeders sans erreur!\n";
    
} catch (Exception $e) {
    echo "‚ùå Erreur: " . $e->getMessage() . "\n";
    echo "üìã Trace: " . $e->getTraceAsString() . "\n";
    exit(1);
}
